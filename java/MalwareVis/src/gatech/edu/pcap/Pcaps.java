package gatech.edu.pcap;
import gatech.edu.util.FileRead;
import gatech.edu.util.FileWrite;

import java.io.File;
import java.net.URL;
import java.util.ArrayList;

public class Pcaps {
	ArrayList<Pcap>pcap_list = new ArrayList<Pcap>();
	long max;
	long min;
	
	public Pcaps(String file){
		File dir = new File(file);
		if(dir.isDirectory()){
			File[] files = dir.listFiles();
			for(File fd:files){
				Pcap pcap = new Pcap(fd.getAbsolutePath());
				pcap_list.add(pcap);
				//System.out.println(pcap.toString());
			}
		}else{
			Pcap pcap = new Pcap(file);
			pcap_list.add(pcap);
		}
		setPcapMaxTime();
		setPcapMinTime();
	}
	
	public Pcaps(URL url) {
		loadFile(url); 
		setPcapMaxTime();
		setPcapMinTime();
	}
	public ArrayList<Pcap> getPcapList(){
		return this.pcap_list;
	}
	
	public int size(){
		return this.pcap_list.size();
	}
	
	public long getPcapsMaxTime(){
		return max;
	}
	
	public long getPcapsMinTime(){
		return min;
	}
		
	public long getPcapsInRange(){
		return (max-min);
	}
	
	private void setPcapMaxTime(){
		long time = 0;
		max = time;
	}
	private void setPcapMinTime(){
		long time = 0;
		min = time;
	}
    public void saveFile(){
    	String filepath =  "data.txt"; 
    	System.out.println("start..save to data.txt"); 
    	FileWrite fw = new FileWrite(filepath);
    	for (Pcap p:pcap_list){
    		fw.writeLine(p.getDigest().getName()); 
    		for (Stream stream: p.getStreams()){
    			if (stream instanceof DNSStream){
    				DNSStream dnsstream = (DNSStream)stream; 
    				String line = dnsstream.toString();  
    				fw.writeLine(line);	
    			}
    			else if (stream instanceof TCPStream){
    				TCPStream tcpstream = (TCPStream)stream; 
    				String line= tcpstream.toString(); 
    				fw.writeLine(line); 
    			}	
    		}
    	}
    	fw.close(); 
    	System.out.println("finish..save to data.txt"); 
    }
	public void loadFile(URL path) {
		FileRead fr = new FileRead(path);
		String line = fr.readLine();
		//System.out.println(line); 
		while (line != null) {
			String name = new String(line);
			ArrayList<Stream> streams = new ArrayList<Stream>();
			line = fr.readLine(); 
			//char start = line.charAt(0); 
			while(line!=null &&(line.charAt(0) =='D' || line.charAt(0) == 'T')){
				if (line.charAt(0) == 'D') {
					DNSStream stream = new DNSStream();
					stream.parse(line);
					streams.add(stream);
					} 
				else if (line.charAt(0) == 'T') {
					TCPStream stream = new TCPStream();
					stream.parse(line);
					//System.out.println(line);
					streams.add(stream);
					} 
				line = fr.readLine();
			}
			pcap_list.add(new Pcap(name, streams)); 
		}
		fr.close();
	}
}
